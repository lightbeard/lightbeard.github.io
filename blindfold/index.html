<!DOCTYPE html>
<html>
<head>
<title>blindfold</title>

<script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>

<script src="chess.min.js"></script>

  <style>
    * {
      font-family: monospace;
      font-size: 5vw;
    }

    .highlight {
      background-color: cyan;
    }
    
    button {
      padding: 0.5em 0.7em;
    }

  </style>

</head>
<p id="san"></p>
FEN:&nbsp;
<input id="fen" type="text" size="50" value="5rk1/8/8/8/8/8/8/4K3 w - - 0 50">
  <br><br>
  <button id="update">update</button>&nbsp;&nbsp;
  <button id="peek">peek</button>&nbsp;&nbsp;
  <button id="pass">pass</button>
<br><br>
<button class="btn">a</button>
<button class="btn">b</button>
<button class="btn">c</button>
<button class="btn">d</button>
<button class="btn">e</button>
<button class="btn">f</button>
<button class="btn">g</button>
<button class="btn">h</button>
<br><br>
<button class="btn">1</button>
<button class="btn">2</button>
<button class="btn">3</button>
<button class="btn">4</button>
<button class="btn">5</button>
<button class="btn">6</button>
<button class="btn">7</button>
<button class="btn">8</button>
<br><br>
<button class="btn">N</button>
<button class="btn">B</button>
<button class="btn">R</button>
<button class="btn">Q</button>
<button class="btn">K</button>
<button class="btn">x</button>


<script>
  
  var select = '';
  
  var cache = localStorage.getItem('fen');
  if(cache) $('#fen').val(cache);

  var chess = new Chess($('#fen').val());
  
  var stockfish = new Worker("stockfish.js");
  stockfish.postMessage("position fen " + $('#fen').val());

  stockfish.onmessage = function(event) {
      if(event.data.indexOf('mate') >= 0) {
        $('#san').html('mate');
      } else if(event.data.indexOf('bestmove') >= 0) {
        var move = /bestmove\s(\w\d)(\w\d)/.exec(event.data);
        var ok = chess.move({from:move[1], to:move[2]});
        
        var san = chess.history()[chess.history().length - 1];
        $('#san').html(san);
      }
  };
  
  $('#update').click(function(e) {
    var fen = $('#fen').val();
    if(chess.validate_fen(fen).valid) {
      localStorage.setItem('fen', fen);
      chess = new Chess(fen);
    } else {
      alert('invalid fen');
    }
  });
  
  $('#peek').click(function() {
    alert(chess.ascii());
  });
  
  $('#pass').click(function() {
     stockfish.postMessage('position fen ' + chess.fen());
     stockfish.postMessage('go depth 8');
  });
  
  $('.btn').click(function(e) {
    var $btn = $(e.target);
    var char = $btn.html();
    var $previous = $('.highlight');

    select += char;
    
    $btn.addClass('highlight');

    if(/\d/.test(char)) {
      
      $('.highlight').removeClass('highlight');
      
      var ok = chess.move(select);
      if(!ok) {
        alert('invalid san: ' + select + '\n' + chess.ascii());
      } else {
        stockfish.postMessage('position fen ' + chess.fen());
        stockfish.postMessage('go depth 8');
      }
      
      select = '';
    }
  });
</script>

<body>
